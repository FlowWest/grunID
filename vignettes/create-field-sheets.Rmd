---
title: "Creating Field Sheets"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Creating Field Sheets}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, include = FALSE}
library(grunID)
library(tidyverse)
```

## Introduction {.tabset}

grunID has several functions to assist in automating the pre-field season workflow. This includes: 

1) Guidance on formatting a sample plan for the database
2) Adding the sample plan to the database ("seeding" sample IDs)
3) Creating field sheets from the database
4) Processing field sheets once they are filled out in the field

## Formatting a sample plan for the database

The run-id database requires that a sample plan contain the following variables: 

* location code
* sample event number
* first sample date
* sample bin
* minimum fork length
* maximum fork length
* expected number of samples per bin


```{r}
sample_plan <- read.csv("data-raw/2022_sample_plan.csv") |> 
  dplyr::distinct_all() |> 
  glimpse()
```

An example sample plan can be downloaded here:
<a href= "https://github.com/SRJPE/grunID/raw/main/inst/example_sample_plan.csv"><button class="btn btn-outline-primary">Download Example Sample Plan </button></a>

## Adding the sample plan to the database

Once you have a formatted sample plan, you can add it to the database using the function `add_sample_plan()`. This function registers new sampling events and generates new sample IDs based on the information contained in the sampling plan. 

When you run `add_sample_plan()`, you are initializing sample IDs for the upcoming season. You will want to store this as an object, as it contains both a) the number of samples created and b) a list of the sample IDs initialized

```{r, eval = FALSE}
con <- grunID::gr_db_connect() # establish connection with the database
sample_plan_created <- grunID::add_sample_plan(con, sample_plan) # add sample plan
```

## Creating field sheets

Once the sample plan is added to the database and the associated sample IDs are created, you can create field sheets automatically using the sample IDs.

First, create the filepath with the desired name of your field sheets. Then run `create_multiple_field_sheets()`:

```{r, eval = FALSE}
filepath <- "field_sheets/my_new_field_sheets.xlsx"
grunID::create_multiple_field_sheets(added_sample_plan = sample_plan_created,
                                     field_sheet_filepath = filepath)
```

Running this function creates a workbook with the title you selected and a tab for each sampling event. If you wish, you can create one field sheet as a time by using the subfunctions `get_field_sheet_sample_plan()` and `create_field_sheet()`. You will need the sampling event ID (stored in the database table `sample_event`):

```{r, eval = FALSE}
con <- grunID::gr_db_connect()
dplyr::tbl(con, "sample_event") # pull sample event ID
sample_event_id <- 2

event_information <- grunID::get_field_sheet_event_plan(con, sample_event_id)
filepath <- "field_sheets/my_new_field_sheets.xlsx"

# create a workbook object
wb <- openxlsx::createWorkbook()

# add event information into the workbook
wb <- grunID::create_field_sheet(wb = wb,
                                 field_sheet_sample_plan = event_information$field_sheet_sample_plan,
                         sample_event_number = event_information$sample_event_number,
                         first_sample_date = event_information$first_sample_date,
                         sample_location = event_information$location_name,
                         sample_location_code = event_information$location_code)

# now save the workbook
openxlsx::saveWorkbook(wb, paste0(filepath), overwrite = TRUE)
```


## Processing field sheets returned from the field


